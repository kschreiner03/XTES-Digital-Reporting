"use strict";const{app:c,BrowserWindow:f,ipcMain:u,dialog:p,Menu:b,shell:v,autoUpdater:m}=require("electron"),{spawn:C}=require("child_process"),a=require("path"),h=require("fs");let s,g;const E=process.env.GITHUB_REPOSITORY||"kschreiner03/XTES-Digital-Reporting",R=process.env.REPORT_ISSUE_URL||"https://forms.office.com/r/A0jqm6vHb6",F=[".dfr",".spdfr",".plog",".clog",".iogc",".json"],j=c.requestSingleInstanceLock();j?c.on("second-instance",(r,d,w)=>{if(s){s.isMinimized()&&s.restore(),s.focus();const l=d.find(e=>F.some(o=>e.endsWith(o)));l&&s.webContents.send("open-file-path",l)}}):c.quit();const P=a.resolve(a.dirname(process.execPath),"..","Update.exe"),D=a.basename(process.execPath);c.once("ready",()=>{if(process.platform==="win32")try{const r=a.join(c.getPath("desktop"),"X-TEC Digital Reporting.lnk");h.existsSync(P)&&!h.existsSync(r)&&(console.log("Creating desktop/start menu shortcuts..."),C(P,["--createShortcut",D],{detached:!0}))}catch(r){console.error("Failed to create shortcuts manually:",r)}});c.on("open-file",(r,d)=>{r.preventDefault();const w=a.extname(d).toLowerCase();F.includes(w)&&(s?s.webContents.send("open-file-path",d):process.argv.push(d))});function _(){if(g){g.focus();return}g=new f({width:960,height:720,title:"Help - X-TES Digital Reporting",webPreferences:{preload:a.join(__dirname,"help-preload.js"),nodeIntegration:!1,contextIsolation:!0,sandbox:!0}}),g.loadFile(a.join(__dirname,"../renderer/main_window/help.html")),g.webContents.setWindowOpenHandler(()=>({action:"deny"})),g.on("closed",()=>{g=null})}const L=[...process.platform==="darwin"?[{label:c.name,submenu:[{role:"about"},{type:"separator"},{role:"services"},{type:"separator"},{role:"hide"},{role:"hideothers"},{role:"unhide"},{type:"separator"},{role:"quit"}]}]:[],{label:"File",submenu:[{label:"Download Photos",click:()=>{s&&s.webContents.send("download-photos")},accelerator:"CmdOrCtrl+D"},{type:"separator"},process.platform==="darwin"?{role:"close"}:{role:"quit"}]},{label:"Settings",submenu:[{label:"Preferences...",click:()=>{s&&s.webContents.send("open-settings")}}]},{label:"Help",submenu:[{label:"How to Use",click:_},{label:"Report Issues",click:async()=>{try{await v.openExternal(R)}catch(r){console.error("Failed to open issue form:",r),p.showErrorBox("Error","Could not open the issue report form.")}}}]}];function S(){s=new f({width:1280,height:960,show:!1,webPreferences:{preload:a.join(__dirname,"preload.js"),nodeIntegration:!1,contextIsolation:!0,sandbox:!1,plugins:!0}}),s.maximize(),s.show(),s.loadFile(a.join(__dirname,"../renderer/main_window/index.html")),s.webContents.setWindowOpenHandler(({url:r})=>(r.startsWith("https:")&&v.openExternal(r),{action:"deny"})),s.webContents.on("context-menu",(r,d)=>{b.buildFromTemplate([{role:"cut",enabled:d.editFlags.canCut},{role:"copy",enabled:d.editFlags.canCopy},{role:"paste",enabled:d.editFlags.canPaste},{type:"separator"},{role:"selectAll",enabled:d.editFlags.canSelectAll}]).popup({window:s})}),s.webContents.on("did-finish-load",()=>{const r=process.argv.find(d=>F.some(w=>d.endsWith(w)));r&&s.webContents.send("open-file-path",r)}),s.on("closed",()=>{s=null})}const k=["Example_DFR.pdf","Example_DFR_Monitoring.pdf","Example_DFR_NonCompliance.pdf","Example_DFR_Herbicide.pdf","Example_DFR_Construction.pdf","Example_DFR_NestSweep.pdf"];c.whenReady().then(()=>{const r=b.buildFromTemplate(L);b.setApplicationMenu(r);const w=`https://update.electronjs.org/${E}/${process.platform}-${process.arch}/${c.getVersion()}`;try{m.setFeedURL(w)}catch(l){console.error("Failed to set auto-updater feed URL:",l)}setTimeout(()=>m.checkForUpdates(),5e3),setInterval(()=>m.checkForUpdates(),60*60*1e3),m.on("update-available",()=>{s&&s.webContents.send("update-available")}),m.on("update-downloaded",(l,e,o)=>{p.showMessageBox({type:"info",buttons:["Restart","Later"],title:"Application Update",message:process.platform==="win32"?e:o,detail:"A new version has been downloaded. Restart the application to apply the updates."}).then(t=>{t.response===0&&m.quitAndInstall()})}),m.on("error",l=>{console.error("There was a problem updating the application"),console.error(l)}),u.handle("open-pdf",async(l,e)=>{if(!k.includes(e)){console.error("Requested PDF is not allowed:",e),p.showErrorBox("Error","The requested file is not a valid example document.");return}const o=c.isPackaged?a.join(process.resourcesPath,"assets"):a.join(c.getAppPath(),"public","assets"),t=a.normalize(a.join(o,e));if(!t.startsWith(o)){console.error("Path traversal attempt detected");return}try{await v.openPath(t)}catch(n){console.error(`Failed to open PDF: ${t}`,n),p.showErrorBox("Error",`Could not open the file: ${t}`)}}),u.handle("get-asset-path",(l,e)=>e.includes("..")||e.includes("/")||e.includes("\\")?"":`file://${a.join(process.resourcesPath,"assets",e).replace(/\\/g,"/")}`),u.handle("save-project",async(l,e,o)=>{const t=f.getFocusedWindow();let n=[{name:"Project Files",extensions:["json"]}];const i=o?a.extname(o).toLowerCase():"";i===".spdfr"?n=[{name:"SaskPower DFR Project",extensions:["spdfr"]}]:i===".dfr"?n=[{name:"X-TES DFR Project",extensions:["dfr"]}]:i===".plog"?n=[{name:"X-TES Photo Log",extensions:["plog"]}]:i===".clog"?n=[{name:"X-TES Combine Logs",extensions:["clog"]}]:i===".iogc"&&(n=[{name:"IOGC Audit File",extensions:["iogc"]}]);const{filePath:x}=await p.showSaveDialog(t,{title:"Save Project",defaultPath:o,filters:n});if(x)try{return h.writeFileSync(x,e),{success:!0,path:x}}catch(y){return console.error("Failed to save project file:",y),{success:!1,error:y.message}}return{success:!1}}),u.handle("load-project",async(l,e)=>{const o=f.getFocusedWindow();let t=[];e==="plog"?t.push({name:"Photo Log Files",extensions:["plog"]}):e==="dfr"?t.push({name:"DFR Standard Files",extensions:["dfr"]}):e==="spdfr"?t.push({name:"SaskPower DFR Files",extensions:["spdfr"]}):e==="clog"?t.push({name:"Combine Logs Files",extensions:["clog"]}):e==="iogc"?t.push({name:"IOGC Audit Files",extensions:["iogc"]}):t.push({name:"All Project Files",extensions:["plog","dfr","spdfr","clog","iogc"]}),t.push({name:"All Files",extensions:["*"]});const{filePaths:n}=await p.showOpenDialog(o,{title:"Open Project",properties:["openFile"],filters:t});if(n&&n.length>0)try{return h.readFileSync(n[0],"utf-8")}catch(i){return console.error("Failed to read project file:",i),null}return null}),u.handle("read-file",async(l,e)=>{if(!e||typeof e!="string")return{success:!1,error:"Invalid path"};const o=a.extname(e).toLowerCase();if(!F.includes(o))return console.error(`Blocked attempt to read unauthorized file type: ${e}`),{success:!1,error:"Unauthorized file type."};try{return{success:!0,data:h.readFileSync(e,"utf-8"),path:e}}catch(t){return console.error("Failed to read file:",t),{success:!1,error:t.message}}}),u.handle("save-pdf",async(l,e,o)=>{const t=f.getFocusedWindow(),{filePath:n}=await p.showSaveDialog(t,{title:"Save PDF",defaultPath:o||"photolog.pdf",filters:[{name:"PDF Files",extensions:["pdf"]}]});if(n)try{return h.writeFileSync(n,Buffer.from(e)),{success:!0,path:n}}catch(i){return console.error("Failed to save PDF file:",i),{success:!1,error:i.message}}return{success:!1}}),u.handle("save-zip-file",async(l,e,o)=>{const t=f.getFocusedWindow(),{filePath:n}=await p.showSaveDialog(t,{title:"Save Photos As...",defaultPath:o,filters:[{name:"Zip Files",extensions:["zip"]}]});if(n)try{return h.writeFileSync(n,Buffer.from(e)),{success:!0,path:n}}catch(i){return console.error("Failed to save zip file:",i),{success:!1,error:i.message}}return{success:!1}}),u.handle("load-multiple-projects",async l=>{const e=f.getFocusedWindow(),{filePaths:o}=await p.showOpenDialog(e,{title:"Import Photos from Files",properties:["openFile","multiSelections"],filters:[{name:"All Project Files",extensions:["plog","dfr","spdfr","json","clog","iogc"]},{name:"Photo Log Files",extensions:["plog","clog"]},{name:"DFR Files",extensions:["dfr","spdfr"]},{name:"IOGC Files",extensions:["iogc"]},{name:"JSON files",extensions:["json"]},{name:"All Files",extensions:["*"]}]});if(o&&o.length>0)try{return{success:!0,data:o.map(n=>{const i=a.extname(n).toLowerCase();if(!F.includes(i))throw new Error("Unauthorized file type selected");return h.readFileSync(n,"utf-8")})}}catch(t){return console.error("Failed to read project files:",t),{success:!1,error:t.message}}return{success:!1,data:[]}}),S(),c.on("activate",()=>{f.getAllWindows().length===0&&S()})});c.on("window-all-closed",()=>{process.platform!=="darwin"&&c.quit()});
